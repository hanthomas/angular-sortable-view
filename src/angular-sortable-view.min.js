!function(L){"use strict";var e=L.module("angular-sortable-view",[]);function x(e){if(!("clientX"in e||"clientY"in e)){var t=e.touches||e.originalEvent.touches;t&&t.length&&(e.clientX=t[0].clientX,e.clientY=t[0].clientY),e.preventDefault()}}e.directive("svRoot",[function(){function C(e){return r[e]}function S(e){return[{x:e.left,y:e.top},{x:e.left+e.width,y:e.top},{x:e.left,y:e.top+e.height},{x:e.left+e.width,y:e.top+e.height},{x:e.left+e.width/2,y:e.top+e.height/2}]}function M(t,e){return t.x>=e[0].x&&t.x<=e[1].x&&t.y>=e[0].y&&t.y<=e[2].y?0:Math.min.apply(Math,e.map(function(e){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}))}var T,r=Object.create(null);return{restrict:"A",controller:["$scope","$attrs","$interpolate","$parse",function(m,e,t,n){var h=t(e.svRoot)(m)||m.$id;r[h]||(r[h]=[]);var p,f,g,y,$,x=!1,a=n(e.svOnSort);e.svOnStart=e.$$element[0].attributes["sv-on-start"],e.svOnStart=e.svOnStart&&e.svOnStart.value,e.svOnStop=e.$$element[0].attributes["sv-on-stop"],e.svOnStop=e.svOnStop&&e.svOnStop.value;var b=n(e.svOnStart),c=n(e.svOnStop);if(this.sortingInProgress=function(){return T},e.svGrid){if(null===(x="true"===e.svGrid||"false"!==e.svGrid&&null))throw"Invalid value of sv-grid attribute"}else m.$watchCollection(function(){return C(h)},function(e){x=!1;var t=e.filter(function(e){return!e.container}).map(function(e){return{part:e.getPart().id,y:e.element[0].getBoundingClientRect().top}}),o=Object.create(null);t.forEach(function(e){o[e.part]?o[e.part].push(e.y):o[e.part]=[e.y]}),Object.keys(o).forEach(function(n){o[n].sort(),o[n].forEach(function(e,t){t<o[n].length-1&&0<e&&e===o[n][t+1]&&(x=!0)})})});var w=!1,o=null;function E(e,t,n){e.scrollTop+=t,w||o||(o=setTimeout(function(){o=null,E(e,t,0)},n))}this.$moveUpdate=function(u,v,e,t,n,o,r){var i=e[0].getBoundingClientRect(),l=o.element[0];"element"===u.tolerance&&(v={x:~~(i.left+i.width/2),y:~~(i.top+i.height/2)}),T=!0,p=[],f||(n?(f=n.clone()).removeClass("ng-hide"):((f=t.clone()).addClass("sv-visibility-hidden"),f.addClass("sv-placeholder"),f.css({height:i.height+"px",width:i.width+"px"})),t.after(f),o.copyMode||t.addClass("ng-hide"),y=t,b(m,{$helper:{element:g=e},$part:o.model(o.scope),$index:r,$item:o.model(o.scope)[r]}),m.$root&&m.$root.$$phase||m.$apply());var s=v.x+document.body.scrollLeft-v.offset.x*i.width,a=v.y+document.body.scrollTop-v.offset.y*i.height;for(g[0].reposition({x:s,y:a});l;){var c=l.getBoundingClientRect();if(a<v.offset.y+c.top-i.height/3){w=!1,E(l,-10,200);break}if(a<=v.offset.y+c.top){w=!1,E(l,-1,200);break}if(a>c.bottom-i.height+i.height/3){w=!1,E(l,10,200);break}if(a>=c.bottom-i.height){w=!1,E(l,1,200);break}w=!0,l=l.parentElement}C(h).forEach(function(e,t){if(null==u.containment||R(e.element,u.containment)||R(e.element,u.containment+" *")){var n,o,r=e.element[0].getBoundingClientRect(),i=S(r),l={x:~~(r.left+r.width/2),y:~~(r.top+r.height/2)},s={x:~~(r.left+r.width/2),y:~~r.top},a={x:~~r.left,y:~~(r.top+r.height/2)};if(!e.container&&(e.element[0].scrollHeight||e.element[0].scrollWidth)){var c=e.getPart();p.push({element:e.element,q:M(v,i),view:c,targetIndex:e.getIndex(),after:(n=l,o=v,("isGrid"in c?c.isGrid:x)?n.x-o.x<0:n.y-o.y<0)})}if(e.container&&!e.element[0].querySelector("[sv-element]:not(.sv-placeholder):not(.sv-source)")){var d=l;"vertical"===e.centerVariant?d=a:"horizontal"===e.centerVariant&&(d=s),p.push({element:e.element,q:(d.x-v.x)*(d.x-v.x)+(d.y-v.y)*(d.y-v.y),view:e.getPart(),targetIndex:0,container:!0})}}});var d=f[0].getBoundingClientRect();p.push({q:M(v,S(d)),element:f,placeholder:!0}),p.sort(function(e,t){return e.q-t.q}),p.forEach(function(e,t){var n,o,r;0!==t||e.placeholder||e.container?0===t&&e.container?($=e).element.append(f):e.element.removeClass("sv-candidate"):(($=e).element.addClass("sv-candidate"),e.after?e.element.after(f):(n=e.element,o=f,0<(r=function(e){{if((e=e[0]).previousElementSibling)return L.element(e.previousElementSibling);for(var t=e.previousSibling;null!=t&&1!=t.nodeType;)t=t.previousSibling;return L.element(t)}}(n)).length?r.after(o):n.parent().prepend(o)))})},this.$drop=function(n,o,r){if(w=!0,f)if(!r.revert||$&&$.view&&$.view.noRevert)s();else{var e=f[0].getBoundingClientRect(),t=g[0].getBoundingClientRect(),i=Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2)),l=r.revert*i/200;l=Math.min(l,+r.revert),["-webkit-","-moz-","-ms-","-o-",""].forEach(function(e){void 0!==g[0].style[e+"transition"]&&(g[0].style[e+"transition"]="all "+l+"ms ease")}),setTimeout(s,l),g.css({top:e.top+document.body.scrollTop+"px",left:e.left+document.body.scrollLeft+"px"})}function s(){if(T=!1,f.remove(),g.remove(),y.removeClass("ng-hide"),y=g=r=f=p=void 0,c(m,{$part:n.model(n.scope),$index:o,$item:n.model(n.scope)[o]}),$){$.element.removeClass("sv-candidate");var e=n.model(n.scope).splice(o,1),t=$.targetIndex;$.view===n&&$.targetIndex>o&&t--,$.after&&t++,$.view.model($.view.scope).splice(t,0,e[0]),$.view===n&&o===t||a(m,{$partTo:$.view.model($.view.scope),$partFrom:n.model(n.scope),$item:e[0],$indexTo:t,$indexFrom:o})}$=void 0,m.$root&&m.$root.$$phase||m.$apply()}},this.addToSortableElements=function(e){C(h).push(e)},this.removeFromSortableElements=function(e){var t=C(h),n=t.indexOf(e);-1<n&&(t.splice(n,1),0===t.length&&delete r[h])}}]}}]),e.directive("svPart",["$parse",function(l){return{restrict:"A",require:"^svRoot",controller:["$scope",function(n){(n.$ctrl=this).getPart=function(){return n.part},this.$drop=function(e,t){n.$sortableRoot.$drop(n.part,e,t)}}],scope:!0,link:function(e,t,n,o){if(!n.svPart)throw new Error("no model provided");var r=l(n.svPart);if(!r.assign)throw new Error("model not assignable");e.part={id:e.$id,element:t,model:r,copyMode:"true"===n.svCopy,noRevert:"true"===n.svNoRevert,scope:e},"isGrid"in n&&(e.part.isGrid="true"===n.isGrid),e.$sortableRoot=o;var i={element:t,getPart:e.$ctrl.getPart,container:!0,centerVariant:n.svCenter||"both"};o.addToSortableElements(i),e.$on("$destroy",function(){o.removeFromSortableElements(i)})}}}]),e.directive("svElement",["$parse",function($){return{restrict:"A",require:["^svPart","^svRoot"],controller:["$scope",function(e){e.$ctrl=this}],link:function(d,u,v,m){var e={element:u,getPart:m[0].getPart,getIndex:function(){return d.$index}};m[1].addToSortableElements(e),d.$on("$destroy",function(){m[1].removeFromSortableElements(e),t.off("touchstart",o),t.off("mousedown",s)});var h,p,t=u;t.on("mousedown",s),t.on("touchstart",o),t.on("touchend",r),d.$watch("$ctrl.handle",function(e){e&&(t.off("touchstart",o),t.off("mousedown",s),(t=e).on("mousedown",s),t.on("touchstart",o))}),d.$watch("$ctrl.helper",function(e){e&&(h=e)}),d.$watch("$ctrl.placeholder",function(e){e&&(p=e)});L.element(document.body);var f,g=L.element(document.documentElement),n=L.extend({},{delay:0},$(v.svElement)(d)),y=null;function o(e){y=setTimeout(i,n.delay),document.addEventListener("touchmove",l),document.addEventListener("touchend",r,{passive:!1})}function r(e){y?(clearTimeout(y),y=null):e.preventDefault(),u.removeClass("sv-touch-move-enabled"),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",r)}function i(){y=null,document.removeEventListener("touchmove",l),document.addEventListener("touchmove",l,{passive:!1}),u.addClass("sv-touch-move-enabled")}function l(e){if(document.removeEventListener("touchmove",l),document.removeEventListener("touchend",r),y)return clearTimeout(y),void(y=null);e.preventDefault(),s(e,!0)}function s(e,t){if((!y||t)&&(x(e),!m[1].sortingInProgress()&&(0==e.button||"mousedown"!==e.type))){var n=e.target.attributes["sv-handle-disabled"];if(!n||"true"!==n.value){f=!1;var o=$(v.svElement)(d);if((o=L.extend({},{startX:e.clientX,startY:e.clientY,tolerance:"pointer",revert:200,containment:"html"},o)).containment)var i=b.call(u,o.containment)[0].getBoundingClientRect();var l,r=u,s=u[0].getBoundingClientRect();h=h||m[0].helper,p=p||m[0].placeholder,h?((l=h.clone()).removeClass("ng-hide"),l.css({left:s.left+document.body.scrollLeft+"px",top:s.top+document.body.scrollTop+"px"}),r.addClass("sv-visibility-hidden")):(l=r.clone()).addClass("sv-helper").css({left:s.left+document.body.scrollLeft+"px",top:s.top+document.body.scrollTop+"px",width:s.width+"px"}),l[0].reposition=function(e){var t=e.x,n=e.y,o=l[0].getBoundingClientRect(),r=document.body;i&&(n<i.top+r.scrollTop&&(n=i.top+r.scrollTop),n+o.height>i.top+r.scrollTop+i.height&&(n=i.top+r.scrollTop+i.height-o.height),t<i.left+r.scrollLeft&&(t=i.left+r.scrollLeft),t+o.width>i.left+r.scrollLeft+i.width&&(t=i.left+r.scrollLeft+i.width-o.width)),this.style.left=t-r.scrollLeft+"px",this.style.top=n-r.scrollTop+"px"};var a={x:(e.clientX-s.left)/s.width,y:(e.clientY-s.top)/s.height};g.addClass("sv-sorting-in-progress"),g.on("mousemove",c).on("mouseup touchend touchcancel",function e(t){g.off("mousemove",c);g.off("mouseup touchend touchcancel",e);document.removeEventListener("touchmove",c,{passive:!1});g.removeClass("sv-sorting-in-progress");u.removeClass("sv-touch-move-enabled");f&&m[0].$drop(d.$index,o);u.removeClass("sv-visibility-hidden")}),document.addEventListener("touchmove",c,{passive:!1}),t&&c(e)}}function c(e){x(e),(e.touches||e.movementX||e.movementY||f)&&(!f&&Math.sqrt(Math.pow(o.startX-e.clientX,2)+Math.pow(o.startY-e.clientY,2))<3||(f||(u.parent().prepend(l),f=!0),m[1].$moveUpdate(o,{x:e.clientX,y:e.clientY,offset:a},l,u,p,m[0].getPart(),d.$index)))}}}}}]),e.directive("svHandle",function(){return{require:"?^svElement",link:function(e,t,n,o){o&&(o.handle=t.add(o.handle))}}}),e.directive("svHelper",function(){return{require:["?^svPart","?^svElement"],link:function(e,t,n,o){t.addClass("sv-helper").addClass("ng-hide"),o[1]?o[1].helper=t:o[0]&&(o[0].helper=t)}}}),e.directive("svPlaceholder",function(){return{require:["?^svPart","?^svElement"],link:function(e,t,n,o){t.addClass("sv-placeholder").addClass("ng-hide"),o[1]?o[1].placeholder=t:o[0]&&(o[0].placeholder=t)}}}),L.element(document.head).append(["<style>.sv-helper{position: fixed !important;z-index: 99999;margin: 0 !important;}.sv-candidate{}.sv-placeholder{}.sv-sorting-in-progress{-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.sv-visibility-hidden{visibility: hidden !important;opacity: 0 !important;}</style>"].join(""));var t=document.documentElement,n=t.matches?"matches":t.matchesSelector?"matchesSelector":t.webkitMatches?"webkitMatches":t.webkitMatchesSelector?"webkitMatchesSelector":t.msMatches?"msMatches":t.msMatchesSelector?"msMatchesSelector":t.mozMatches?"mozMatches":t.mozMatchesSelector?"mozMatchesSelector":null;if(null==n)throw"This browser doesn't support the HTMLElement.matches method";function R(e,t){return e instanceof L.element&&(e=e[0]),null!==n?e[n](t):void 0}var b=L.element.prototype.closest||function(e){for(var t=this[0].parentNode;t!==document.documentElement&&!t[n](e);)t=t.parentNode;return t[n](e)?L.element(t):L.element()};"function"!=typeof L.element.prototype.add&&(L.element.prototype.add=function(e){var t,n=L.element();for(e=L.element(e),t=0;t<this.length;t++)n.push(this[t]);for(t=0;t<e.length;t++)n.push(e[t]);return n})}((window,angular));
