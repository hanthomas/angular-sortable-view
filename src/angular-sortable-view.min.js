/*
	Copyright Kamil PÄ™kala http://github.com/kamilkp
	angular-sortable-view v0.0.13 2015/01/13
*/
!function(a,b){"use strict";function c(a){if(!("clientX"in a||"clientY"in a)){var b=a.touches||a.originalEvent.touches;b&&b.length&&(a.clientX=b[0].clientX,a.clientY=b[0].clientY),a.preventDefault()}}function d(a){if(a=a[0],a.previousElementSibling)return b.element(a.previousElementSibling);for(var c=a.previousSibling;null!=c&&1!=c.nodeType;)c=c.previousSibling;return b.element(c)}function e(a,b){var c=d(a);c.length>0?c.after(b):a.parent().prepend(b)}function f(a,c){if(a instanceof b.element&&(a=a[0]),null!==i)return a[i](c)}var g=b.module("angular-sortable-view",[]);g.directive("svRoot",[function(){function a(a,b,c){return c?a.x-b.x<0:a.y-b.y<0}function b(a){return i[a]}function c(a){delete i[a]}function d(a){return[{x:a.left,y:a.top},{x:a.left+a.width,y:a.top},{x:a.left,y:a.top+a.height},{x:a.left+a.width,y:a.top+a.height},{x:a.left+a.width/2,y:a.top+a.height/2}]}function g(a,b){return a.x>=b[0].x&&a.x<=b[1].x&&a.y>=b[0].y&&a.y<=b[2].y?0:Math.min.apply(Math,b.map(function(b){return(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y)}))}var h,i=Object.create(null);return{restrict:"A",controller:["$scope","$attrs","$interpolate","$parse",function(j,k,l,m){function n(a,b,c){a.scrollTop+=b,z||A||(A=setTimeout(function(){A=null,n(a,b,0)},c))}var o=l(k.svRoot)(j)||j.$id;i[o]||(i[o]=[]);var p,q,r,s,t,u,v=!1,w=m(k.svOnSort);k.svOnStart=k.$$element[0].attributes["sv-on-start"],k.svOnStart=k.svOnStart&&k.svOnStart.value,k.svOnStop=k.$$element[0].attributes["sv-on-stop"],k.svOnStop=k.svOnStop&&k.svOnStop.value;var x=m(k.svOnStart),y=m(k.svOnStop);if(this.sortingInProgress=function(){return h},k.svGrid){if(null===(v="true"===k.svGrid||"false"!==k.svGrid&&null))throw"Invalid value of sv-grid attribute"}else j.$watchCollection(function(){return b(o)},function(a){v=!1;var b=a.filter(function(a){return!a.container}).map(function(a){return{part:a.getPart().id,y:a.element[0].getBoundingClientRect().top}}),c=Object.create(null);b.forEach(function(a){c[a.part]?c[a.part].push(a.y):c[a.part]=[a.y]}),Object.keys(c).forEach(function(a){c[a].sort(),c[a].forEach(function(b,d){d<c[a].length-1&&b>0&&b===c[a][d+1]&&(v=!0)})})});var z=!1,A=null;this.$moveUpdate=function(c,i,k,l,m,w,y){var A=k[0].getBoundingClientRect(),B=w.element[0];"element"===c.tolerance&&(i={x:~~(A.left+A.width/2),y:~~(A.top+A.height/2)}),h=!0,p=[],q||(m?(q=m.clone(),q.removeClass("ng-hide")):(q=l.clone(),q.addClass("sv-visibility-hidden"),q.addClass("sv-placeholder"),q.css({height:A.height+"px",width:A.width+"px"})),l.after(q),w.copyMode||l.addClass("ng-hide"),t=l,r=c,s=k,x(j,{$helper:{element:s},$part:w.model(w.scope),$index:y,$item:w.model(w.scope)[y]}),j.$root&&j.$root.$$phase||j.$apply());var C=i.x+document.body.scrollLeft-i.offset.x*A.width,D=i.y+document.body.scrollTop-i.offset.y*A.height;s[0].reposition({x:C,y:D});var E=B.getBoundingClientRect();D<i.offset.y+E.top-A.height/3?(z=!1,n(B,-10,200)):D<=i.offset.y+E.top?(z=!1,n(B,-1,200)):D>E.bottom-A.height+A.height/3?(z=!1,n(B,10,200)):D>=E.bottom-A.height?(z=!1,n(B,1,200)):z=!0,b(o).forEach(function(b,e){if(null==c.containment||f(b.element,c.containment)||f(b.element,c.containment+" *")){var h=b.element[0].getBoundingClientRect(),j=d(h),k={x:~~(h.left+h.width/2),y:~~(h.top+h.height/2)},l={x:~~(h.left+h.width/2),y:~~h.top},m={x:~~h.left,y:~~(h.top+h.height/2)};if(!b.container&&(b.element[0].scrollHeight||b.element[0].scrollWidth)){var n=b.getPart();p.push({element:b.element,q:g(i,j),view:n,targetIndex:b.getIndex(),after:a(k,i,"isGrid"in n?n.isGrid:v)})}if(b.container&&!b.element[0].querySelector("[sv-element]:not(.sv-placeholder):not(.sv-source)")){var o=k;"vertical"===b.centerVariant?o=m:"horizontal"===b.centerVariant&&(o=l),p.push({element:b.element,q:(o.x-i.x)*(o.x-i.x)+(o.y-i.y)*(o.y-i.y),view:b.getPart(),targetIndex:0,container:!0})}}});var F=q[0].getBoundingClientRect();p.push({q:g(i,d(F)),element:q,placeholder:!0}),p.sort(function(a,b){return a.q-b.q}),p.forEach(function(a,b){0!==b||a.placeholder||a.container?0===b&&a.container?(u=a,a.element.append(q)):a.element.removeClass("sv-candidate"):(u=a,a.element.addClass("sv-candidate"),a.after?a.element.after(q):e(a.element,q))})},this.$drop=function(a,b,c){function d(){if(h=!1,q.remove(),s.remove(),t.removeClass("ng-hide"),p=void 0,q=void 0,c=void 0,s=void 0,t=void 0,y(j,{$part:a.model(a.scope),$index:b,$item:a.model(a.scope)[b]}),u){u.element.removeClass("sv-candidate");var d=a.model(a.scope).splice(b,1),e=u.targetIndex;u.view===a&&u.targetIndex>b&&e--,u.after&&e++,u.view.model(u.view.scope).splice(e,0,d[0]),u.view===a&&b===e||w(j,{$partTo:u.view.model(u.view.scope),$partFrom:a.model(a.scope),$item:d[0],$indexTo:e,$indexFrom:b})}u=void 0,j.$root&&j.$root.$$phase||j.$apply()}if(z=!0,q)if(!c.revert||u&&u.view&&u.view.noRevert)d();else{var e=q[0].getBoundingClientRect(),f=s[0].getBoundingClientRect(),g=Math.sqrt(Math.pow(f.top-e.top,2)+Math.pow(f.left-e.left,2)),i=+c.revert*g/200;i=Math.min(i,+c.revert),["-webkit-","-moz-","-ms-","-o-",""].forEach(function(a){void 0!==s[0].style[a+"transition"]&&(s[0].style[a+"transition"]="all "+i+"ms ease")}),setTimeout(d,i),s.css({top:e.top+document.body.scrollTop+"px",left:e.left+document.body.scrollLeft+"px"})}},this.addToSortableElements=function(a){b(o).push(a)},this.removeFromSortableElements=function(a){var d=b(o),e=d.indexOf(a);e>-1&&(d.splice(e,1),0===d.length&&c(o))}}]}}]),g.directive("svPart",["$parse",function(a){return{restrict:"A",require:"^svRoot",controller:["$scope",function(a){a.$ctrl=this,this.getPart=function(){return a.part},this.$drop=function(b,c){a.$sortableRoot.$drop(a.part,b,c)}}],scope:!0,link:function(b,c,d,e){if(!d.svPart)throw new Error("no model provided");var f=a(d.svPart);if(!f.assign)throw new Error("model not assignable");b.part={id:b.$id,element:c,model:f,copyMode:"true"===d.svCopy,noRevert:"true"===d.svNoRevert,scope:b},"isGrid"in d&&(b.part.isGrid="true"===d.isGrid),b.$sortableRoot=e;var g={element:c,getPart:b.$ctrl.getPart,container:!0,centerVariant:d.svCenter||"both"};e.addToSortableElements(g),b.$on("$destroy",function(){e.removeFromSortableElements(g)})}}}]),g.directive("svElement",["$parse",function(a){return{restrict:"A",require:["^svPart","^svRoot"],controller:["$scope",function(a){a.$ctrl=this}],link:function(d,e,f,g){function h(a){t=setTimeout(k,700),document.addEventListener("touchmove",l),document.addEventListener("touchend",i,{passive:!1})}function i(a){t?(clearTimeout(t),t=null):a.preventDefault(),e.removeClass("sv-touch-move-enabled"),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",i)}function k(){t=null,document.removeEventListener("touchmove",l),document.addEventListener("touchmove",l,{passive:!1}),e.addClass("sv-touch-move-enabled")}function l(a){if(document.removeEventListener("touchmove",l),document.removeEventListener("touchend",i),t)return clearTimeout(t),void(t=null);a.preventDefault(),m(a,!0)}function m(h,i){function k(a){s.off("mousemove",l),s.off("mouseup touchend touchcancel",k),document.removeEventListener("touchmove",l,{passive:!1}),s.removeClass("sv-sorting-in-progress"),e.removeClass("sv-touch-move-enabled"),r&&g[0].$drop(d.$index,n),e.removeClass("sv-visibility-hidden")}function l(a){c(a),(a.touches||a.movementX||a.movementY||r)&&(!r&&Math.sqrt(Math.pow(n.startX-a.clientX,2)+Math.pow(n.startY-a.clientY,2))<3||(r||(e.parent().prepend(t),r=!0),g[1].$moveUpdate(n,{x:a.clientX,y:a.clientY,offset:w},t,e,q,g[0].getPart(),d.$index)))}if(c(h),!g[1].sortingInProgress()&&(0==h.button||"mousedown"!==h.type)){var m=h.target.attributes["sv-handle-disabled"];if(!m||"true"!==m.value){r=!1;var n=a(f.svElement)(d);if(n=b.extend({},{startX:h.clientX,startY:h.clientY,tolerance:"pointer",revert:200,containment:"html"},n),n.containment)var o=j.call(e,n.containment)[0].getBoundingClientRect();var t,u=e,v=e[0].getBoundingClientRect();p||(p=g[0].helper),q||(q=g[0].placeholder),p?(t=p.clone(),t.removeClass("ng-hide"),t.css({left:v.left+document.body.scrollLeft+"px",top:v.top+document.body.scrollTop+"px"}),u.addClass("sv-visibility-hidden")):(t=u.clone(),t.addClass("sv-helper").css({left:v.left+document.body.scrollLeft+"px",top:v.top+document.body.scrollTop+"px",width:v.width+"px"})),t[0].reposition=function(a){var b=a.x,c=a.y,d=t[0].getBoundingClientRect(),e=document.body;o&&(c<o.top+e.scrollTop&&(c=o.top+e.scrollTop),c+d.height>o.top+e.scrollTop+o.height&&(c=o.top+e.scrollTop+o.height-d.height),b<o.left+e.scrollLeft&&(b=o.left+e.scrollLeft),b+d.width>o.left+e.scrollLeft+o.width&&(b=o.left+e.scrollLeft+o.width-d.width)),this.style.left=b-e.scrollLeft+"px",this.style.top=c-e.scrollTop+"px"};var w={x:(h.clientX-v.left)/v.width,y:(h.clientY-v.top)/v.height};s.addClass("sv-sorting-in-progress"),s.on("mousemove",l).on("mouseup touchend touchcancel",k),document.addEventListener("touchmove",l,{passive:!1}),i&&l(h)}}}var n={element:e,getPart:g[0].getPart,getIndex:function(){return d.$index}};g[1].addToSortableElements(n),d.$on("$destroy",function(){g[1].removeFromSortableElements(n),o.off("touchstart",h),o.off("mousedown",m)});var o=e;o.on("mousedown",m),o.on("touchstart",h),o.on("touchend",i),d.$watch("$ctrl.handle",function(a){a&&(o.off("touchstart",h),o.off("mousedown",m),o=a,o.on("mousedown",m),o.on("touchstart",h))});var p;d.$watch("$ctrl.helper",function(a){a&&(p=a)});var q;d.$watch("$ctrl.placeholder",function(a){a&&(q=a)});var r,s=(b.element(document.body),b.element(document.documentElement)),t=null}}}]),g.directive("svHandle",function(){return{require:"?^svElement",link:function(a,b,c,d){d&&(d.handle=b.add(d.handle))}}}),g.directive("svHelper",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-helper").addClass("ng-hide"),d[1]?d[1].helper=b:d[0]&&(d[0].helper=b)}}}),g.directive("svPlaceholder",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-placeholder").addClass("ng-hide"),d[1]?d[1].placeholder=b:d[0]&&(d[0].placeholder=b)}}}),b.element(document.head).append(["<style>.sv-helper{position: fixed !important;z-index: 99999;margin: 0 !important;}.sv-candidate{}.sv-placeholder{}.sv-sorting-in-progress{-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.sv-visibility-hidden{visibility: hidden !important;opacity: 0 !important;}</style>"].join(""));var h=document.documentElement,i=h.matches?"matches":h.matchesSelector?"matchesSelector":h.webkitMatches?"webkitMatches":h.webkitMatchesSelector?"webkitMatchesSelector":h.msMatches?"msMatches":h.msMatchesSelector?"msMatchesSelector":h.mozMatches?"mozMatches":h.mozMatchesSelector?"mozMatchesSelector":null;if(null==i)throw"This browser doesn't support the HTMLElement.matches method";var j=b.element.prototype.closest||function(a){for(var c=this[0].parentNode;c!==document.documentElement&&!c[i](a);)c=c.parentNode;return c[i](a)?b.element(c):b.element()};"function"!=typeof b.element.prototype.add&&(b.element.prototype.add=function(a){var c,d=b.element();for(a=b.element(a),c=0;c<this.length;c++)d.push(this[c]);for(c=0;c<a.length;c++)d.push(a[c]);return d})}(window,angular);